import hljs from "highlight.js";
import { ViewHook } from "phoenix_live_view";

import { updateLineNumbers } from "./update_line_numbers";

type CodeBlock = HTMLElement | null;
interface Highlight extends ViewHook {
  getSyntaxType: (name: string) => void;
  trimCodeBlock: (codeBlock: CodeBlock) => NonNullable<CodeBlock>;
}

const Highlight = {
  mounted(this: Highlight) {
    const name = this.el.getAttribute("data-name");
    const codeBlock: CodeBlock = this.el.querySelector("pre code");

    if (name && codeBlock) {
      codeBlock.className = codeBlock.className.replace(/language-\S+/g, "");
      codeBlock.classList.add(`language-${this.getSyntaxType(name)}`);

      const trimmed: HTMLElement = this.trimCodeBlock(codeBlock);
      hljs.highlightElement(codeBlock);
      if (trimmed.textContent) updateLineNumbers(trimmed.textContent);
    }
  },

  getSyntaxType(name) {
    const extension = name.split(".").pop();
    switch (extension) {
      case "asc":
      case "ash":
        return "ags-script";
      case "mod":
      case "g4":
        return "antlr";
      case "apib":
        return "api-blueprint";
      case "dyalog":
      case "asax":
      case "ascx":
      case "ashx":
      case "asmx":
      case "aspx":
      case "axd":
      case "dats":
      case "hats":
      case "sats":
        return "ats";
      case "as":
        return "actionscript";
      case "adb":
      case "ads":
      case "als":
        return "alloy";
      case "vhost":
      case "cls":
        return "apex";
      case "scpt":
      case "ino":
        return "arduino";
      case "adoc":
      case "aj":
        return "aspectj";
      case "asm":
      case "a51":
      case "inc":
      case "nasm":
        return "assembly";
      case "aug":
        return "augeas";
      case "ahk":
      case "ahkl":
        return "autohotkey";
      case "au3":
        return "autoit";
      case "auk":
      case "gawk":
      case "mawk":
      case "nawk":
      case "bat":
      case "cmd":
        return "batchfile";
      case "bb":
        return "bitbake";
      case "decls":
        return "blitzbasic";
      case "bmx":
        return "blitzmax";
      case "bsv":
        return "bluespec";
      case "b":
      case "bf":
        return "brainfuck";
      case "brs":
        return "brightscript";
      case "cats":
      case "h":
      case "idc":
      case "w":
      case "cs":
      case "cake":
      case "cshtml":
      case "csx":
        return "c#";
      case "cpp":
      case "cc":
      case "cp":
      case "cxx":
      case "h++":
      case "hh":
      case "hpp":
      case "hxx":
      case "inl":
      case "ipp":
      case "tcc":
      case "tpp":
      case "chs":
        return "c2hs-haskell";
      case "clp":
        return "clips";
      case "cmake.in":
      case "cob":
      case "cbl":
      case "ccp":
      case "cpy":
      case "capnp":
        return "cap'n-proto";
      case "mss":
        return "cartocss";
      case "chpl":
        return "chapel";
      case "ch":
        return "charity";
      case "ck":
        return "chuck";
      case "clw":
        return "clarion";
      case "icl":
      case "dcl":
        return "clean";
      case "clj":
      case "boot":
      case "cl2":
      case "cljc":
      case "cljs":
      case "cljs.hl":
      case "cljscm":
      case "cljx":
      case "hic":
        return "clojure";
      case "coffee":
      case "_coffee":
      case "cjsx":
      case "cson":
      case "iced":
        return "coffeescript";
      case "cfm":
      case "cfml":
        return "coldfusion";
      case "cfc":
        return "coldfusion-cfc";
      case "lisp":
      case "asd":
      case "cl":
      case "l":
      case "lsp":
      case "ny":
      case "podsl":
      case "sexp":
        return "common-lisp";
      case "cps":
        return "component-pascal";
      case "v":
      case "cppobjdump":
      case "c++-objdump":
      case "c++objdump":
      case "cxx-objdump":
      case "cr":
        return "crystal";
      case "feature":
        return "cucumber";
      case "cu":
      case "cuh":
        return "cuda";
      case "cy":
        return "cycript";
      case "pyx":
      case "pxd":
      case "pxi":
        return "cython";
      case "di":
      case "com":
        return "digital-command-language";
      case "zone":
      case "arpa":
        return "dns-zone";
      case "d":
        return "dtrace";
      case "darcspatch":
      case "dpatch":
        return "darcs-patch";
      case "patch":
      case "djs":
        return "dogescript";
      case "dyl":
      case "intr":
      case "lid":
      case "E":
        return "e";
      case "eclxml":
      case "ecl":
        return "eclipse";
      case "sch":
      case "brd":
        return "eagle";
      case "epj":
        return "ecere-projects";
      case "e":
        return "eiffel";
      case "ex":
      case "exs":
        return "elixir";
      case "el":
      case "emacs":
      case "emacs.desktop":
        return "emacs-lisp";
      case "em":
      case "erl":
      case "es":
      case "escript":
      case "hrl":
      case "xrl":
      case "yrl":
        return "erlang";
      case "fsi":
      case "fsx":
        return "f#";
      case "fx":
      case "f90":
      case "f":
      case "f03":
      case "f08":
      case "f77":
      case "f95":
      case "for":
      case "fpp":
        return "fortran";
      case "fy":
      case "fancypack":
        return "fancy";
      case "fan":
        return "fantom";
      case "fs":
        return "filterscript";
      case "eam.fs":
        return "formatted";
      case "fth":
      case "4th":
      case "frt":
      case "ftl":
        return "freemarker";
      case "fr":
        return "frege";
      case "g":
      case "gco":
      case "gcode":
        return "g-code";
      case "gms":
        return "gams";
      case "gd":
      case "gi":
      case "tst":
      case "s":
      case "ms":
        return "gas";
      case "fp":
      case "frag":
      case "frg":
      case "fsh":
      case "fshader":
      case "geo":
      case "geom":
      case "glslv":
      case "gshader":
      case "shader":
      case "vert":
      case "vrx":
      case "vsh":
      case "vshader":
      case "gml":
        return "game-maker-language";
      case "kid":
        return "genshi";
      case "ebuild":
        return "gentoo-ebuild";
      case "eclass":
        return "gentoo-eclass";
      case "po":
      case "pot":
        return "gettext-catalog";
      case "glf":
        return "glyph";
      case "gp":
      case "gnu":
      case "plot":
      case "plt":
      case "gs":
      case "gst":
      case "gsx":
      case "vark":
        return "gosu";
      case "gf":
        return "grammatical-framework";
      case "gml":
        return "graph-modeling-language";
      case "dot":
      case "gv":
        return "graphviz";
      case "man":
      case "1":
      case "1in":
      case "1m":
      case "1x":
      case "2":
      case "3":
      case "3in":
      case "3m":
      case "3qt":
      case "3x":
      case "4":
      case "5":
      case "6":
      case "7":
      case "8":
      case "9":
      case "me":
      case "n":
      case "rno":
      case "roff":
        return "groff";
      case "grt":
      case "gtpl":
      case "gvy":
      case "gsp":
        return "groovy-server-pages";
      case "tf":
      case "fxh":
      case "hlsli":
      case "htm":
      case "html.hl":
      case "st":
      case "xht":
      case "xhtml":
      case "mustache":
      case "erb.deface":
      case "jinja":
      case "erb":
      case "eex":
      case "heex":
      case "phtml":
        return "html";
      case "php":
        return "php";
      case "haml.deface":
      case "hbs":
      case "hb":
        return "harbour";
      case "hs":
      case "hsc":
        return "haskell";
      case "hx":
      case "hxsl":
        return "haxe";
      case "pro":
      case "dlm":
        return "idl";
      case "ipf":
        return "igor-pro";
      case "cfg":
      case "prefs":
      case "properties":
      case "irclog":
      case "weechatlog":
        return "irc-log";
      case "idr":
      case "lidr":
        return "idris";
      case "ni":
      case "i7x":
        return "inform-7";
      case "iss":
        return "inno-setup";
      case "ik":
        return "ioke";
      case "thy":
        return "isabelle";
      case "ijs":
        return "j";
      case "flex":
      case "geojson":
      case "lock":
      case "topojson":
      case "jq":
        return "jsoniq";
      case "j":
        return "jasmin";
      case "jsp":
        return "java-server-pages";
      case "js":
      case "_js":
      case "bones":
      case "es6":
      case "jake":
      case "jsb":
      case "jscad":
      case "jsfl":
      case "jsm":
      case "jss":
      case "njs":
      case "pac":
      case "sjs":
      case "ssjs":
      case "sublime-build":
      case "sublime-commands":
      case "sublime-completions":
      case "sublime-keymap":
      case "sublime-macro":
      case "sublime-menu":
      case "sublime-mousemap":
      case "sublime-project":
      case "sublime-settings":
      case "sublime-theme":
      case "sublime-workspace":
      case "sublime_metrics":
      case "sublime_session":
      case "xsjs":
      case "xsjslib":
        return "javascript";
      case "jl":
        return "julia";
      case "ipynb":
        return "jupyter-notebook";
      case "kicad_pcb":
        return "kicad";
      case "kt":
      case "ktm":
      case "kts":
        return "kotlin";
      case "ll":
        return "llvm";
      case "lol":
        return "lolcode";
      case "lslp":
      case "lvproj":
        return "labview";
      case "las":
      case "lasso8":
      case "lasso9":
      case "ldml":
      case "hlean":
      case "ly":
      case "ily":
        return "lilypond";
      case "ld":
      case "lds":
        return "linker-script";
      case "lagda":
        return "literate-agda";
      case "litcoffee":
        return "literate-coffeescript";
      case "lhs":
        return "literate-haskell";
      case "ls":
      case "_ls":
        return "livescript";
      case "xm":
      case "x":
      case "xi":
        return "logos";
      case "lgt":
        return "loomscript";
      case "fcgi":
      case "nse":
      case "pd_lua":
      case "rbxs":
      case "wlua":
      case "mumps":
      case "m4":
        return "m4sugar";
      case "mcr":
        return "maxscript";
      case "mak":
      case "mk":
      case "mkfile":
        return "makefile";
      case "mao":
      case "md":
      case "mkd":
      case "mkdn":
      case "mkdown":
      case "ron":
      case "cdf":
      case "ma":
      case "mt":
      case "nb":
      case "nbp":
      case "wl":
      case "wlt":
      case "maxpat":
      case "maxhelp":
      case "maxproj":
      case "mxt":
      case "pat":
        return "max";
      case "wiki":
      case "moo":
        return "mercury";
      case "druby":
      case "duby":
      case "mir":
      case "mo":
        return "modelica";
      case "mms":
      case "mmk":
        return "module-management-system";
      case "moon":
        return "moonscript";
      case "myt":
        return "myghty";
      case "nsi":
      case "nsh":
        return "nsis";
      case "axs":
      case "axi":
        return "netlinx";
      case "axs.erb":
      case "axi.erb":
        return "netlinx+erb";
      case "nlogo":
        return "netlogo";
      case "nl":
        return "newlisp";
      case "nginxconf":
        return "nginx";
      case "nim":
      case "numpyw":
      case "numsc":
      case "ml":
      case "eliom":
      case "eliomi":
      case "ml4":
      case "mli":
      case "mll":
      case "mly":
        return "ocaml";
      case "m":
        return "objective-c";
      case "mm":
        return "objective-c++";
      case "sj":
        return "objective-j";
      case "p":
        return "openedge-abl";
      case "scad":
        return "openscad";
      case "oxh":
      case "oxo":
      case "pwn":
        return "pawn";
      case "aw":
      case "ctp":
      case "php3":
      case "php4":
      case "php5":
      case "phps":
      case "phpt":
      case "pls":
      case "pck":
      case "pkb":
      case "pks":
      case "plb":
      case "sql":
        return "plpgsql";
      case "pov":
        return "pov-ray-sdl";
      case "psc":
        return "papyrus";
      case "pasm":
        return "parrot-assembly";
      case "pir":
        return "parrot-internal-representation";
      case "pas":
      case "dfm":
      case "dpr":
      case "lpr":
      case "pp":
        return "pascal";
      case "pl":
      case "al":
      case "cgi":
      case "ph":
      case "plx":
      case "pm":
      case "pod":
      case "psgi":
      case "t":
      case "6pl":
      case "6pm":
      case "nqp":
      case "p6":
      case "p6l":
      case "p6m":
      case "pl6":
      case "pm6":
        return "perl6";
      case "pkl":
        return "pickle";
      case "pig":
        return "piglatin";
      case "pmod":
      case "pogo":
        return "pogoscript";
      case "ps":
      case "eps":
        return "postscript";
      case "ps1":
      case "psd1":
      case "psm1":
        return "powershell";
      case "pde":
        return "processing";
      case "yap":
      case "spin":
        return "propeller-spin";
      case "proto":
        return "protocol-buffer";
      case "pub":
        return "public-key";
      case "pd":
        return "pure-data";
      case "pb":
      case "pbi":
        return "purebasic";
      case "purs":
        return "purescript";
      case "py":
      case "bzl":
      case "gyp":
      case "lmi":
      case "pyde":
      case "pyp":
      case "pyt":
      case "pyw":
      case "rpy":
      case "tac":
      case "wsgi":
      case "xpy":
        return "python";
      case "pytb":
        return "python-traceback";
      case "qbs":
      case "pri":
        return "qmake";
      case "rd":
      case "rsx":
      case "rbbas":
      case "rbfrm":
      case "rbmnu":
      case "rbres":
      case "rbtbar":
      case "rbuistate":
        return "realbasic";
      case "rmd":
        return "rmarkdown";
      case "rkt":
      case "rktd":
      case "rktl":
      case "scrbl":
        return "racket";
      case "rl":
        return "ragel-in-ruby-host";
      case "raw":
        return "raw-token-data";
      case "reb":
      case "r":
      case "r2":
      case "r3":
      case "reds":
      case "cw":
        return "redcode";
      case "rsh":
        return "renderscript";
      case "robot":
        return "robotframework";
      case "rg":
        return "rouge";
      case "rb":
      case "builder":
      case "gemspec":
      case "god":
      case "irbrc":
      case "jbuilder":
      case "mspec":
      case "pluginspec":
      case "podspec":
      case "rabl":
      case "rake":
      case "rbuild":
      case "rbw":
      case "rbx":
      case "ru":
      case "thor":
      case "watchr":
      case "rs":
      case "rs.in":
        return "rust";
      case "smt2":
      case "rq":
      case "hqf":
      case "cql":
      case "ddl":
      case "prc":
      case "tab":
      case "udf":
      case "viw":
      case "db2":
        return "sqlpl";
      case "sagews":
      case "sls":
        return "saltstack";
      case "sbt":
      case "sc":
      case "scm":
      case "sld":
      case "sps":
      case "ss":
        return "scheme";
      case "sci":
      case "sce":
        return "scilab";
      case "sh":
      case "bash":
      case "bats":
      case "command":
      case "ksh":
      case "sh.in":
      case "tmux":
      case "tool":
      case "zsh":
        return "shell";
      case "sh-session":
        return "shellsession";
      case "sl":
        return "slash";
      case "tpl":
        return "smarty";
      case "sp":
      case "sma":
        return "sourcepawn";
      case "nut":
        return "squirrel";
      case "ML":
      case "fun":
      case "sig":
      case "sml":
        return "standard-ml";
      case "do":
      case "ado":
      case "doh":
      case "ihlp":
      case "mata":
      case "matah":
      case "sthlp":
        return "stata";
      case "styl":
        return "stylus";
      case "scd":
        return "supercollider";
      case "sv":
      case "svh":
      case "vh":
        return "systemverilog";
      case "adp":
      case "tm":
      case "csh":
      case "aux":
      case "bbx":
      case "bib":
      case "cbx":
      case "dtx":
      case "ins":
      case "lbx":
      case "ltx":
      case "mkii":
      case "mkiv":
      case "mkvi":
      case "sty":
      case "toc":
        return "terra";
      case "txt":
      case "ncl":
      case "no":
        return "text";
      case "tu":
        return "turing";
      case "ttl":
        return "turtle";
      case "ts":
      case "tsx":
        return "typescript";
      case "upc":
        return "unified-parallel-c";
      case "anim":
      case "asset":
      case "mat":
      case "meta":
      case "prefab":
      case "unity":
        return "unity3d-asset";
      case "uc":
        return "unrealscript";
      case "ur":
      case "urs":
        return "urweb";
      case "vhd":
      case "vhf":
      case "vhi":
      case "vho":
      case "vhs":
      case "vht":
      case "vhw":
      case "vapi":
      case "veo":
        return "verilog";
      case "vim":
        return "viml";
      case "vb":
      case "bas":
      case "frm":
      case "frx":
      case "vba":
      case "vbhtml":
      case "vbs":
        return "visual-basic";
      case "owl":
        return "web-ontology-language";
      case "ant":
      case "axml":
      case "ccxml":
      case "clixml":
      case "cproject":
      case "csl":
      case "csproj":
      case "ct":
      case "dita":
      case "ditamap":
      case "ditaval":
      case "dll.config":
      case "dotsettings":
      case "filters":
      case "fsproj":
      case "fxml":
      case "glade":
      case "gml":
      case "grxml":
      case "iml":
      case "ivy":
      case "jelly":
      case "jsproj":
      case "kml":
      case "launch":
      case "mdpolicy":
      case "mxml":
      case "nproj":
      case "nuspec":
      case "odd":
      case "osm":
      case "plist":
      case "props":
      case "ps1xml":
      case "psc1":
      case "pt":
      case "rdf":
      case "rss":
      case "scxml":
      case "srdf":
      case "storyboard":
      case "stTheme":
      case "sublime-snippet":
      case "targets":
      case "tmCommand":
      case "tml":
      case "tmLanguage":
      case "tmPreferences":
      case "tmSnippet":
      case "tmTheme":
      case "ui":
      case "urdf":
      case "ux":
      case "vbproj":
      case "vcxproj":
      case "vssettings":
      case "vxml":
      case "wsdl":
      case "wsf":
      case "wxi":
      case "wxl":
      case "wxs":
      case "x3d":
      case "xacro":
      case "xaml":
      case "xib":
      case "xlf":
      case "xliff":
      case "xmi":
      case "xml.dist":
      case "xproj":
      case "xsd":
      case "xul":
      case "zcml":
      case "xsp-config":
      case "xsp.metadata":
        return "xpages";
      case "xpl":
      case "xq":
      case "xql":
      case "xqm":
      case "xqy":
      case "xsl":
      case "xojo_code":
      case "xojo_menu":
      case "xojo_report":
      case "xojo_script":
      case "xojo_toolbar":
      case "xojo_window":
        return "xojo";
      case "yml":
      case "reek":
      case "rviz":
      case "sublime-syntax":
      case "syntax":
      case "yaml-tmlanguage":
      case "y":
      case "yy":
      case "zep":
        return "zephir";
      case "zmpl":
      case "zpl":
      case "desktop.in":
      case "eh":
      case "mu":
        return "mupad";
      case "nc":
        return "nesc";
      case "rst":
      case "rest":
      case "rest.txt":
      case "rst.txt":
        return "restructuredtext";
      case "prg":
      case "prw":
        return "xbase";
      default:
        return extension;
    }
  },

  trimCodeBlock(codeBlock: HTMLElement): HTMLElement {
    const lines = codeBlock.textContent?.split("\n");
    if (lines && lines.length > 2) {
      lines.shift();
      lines.pop();
    }

    codeBlock.textContent = lines?.join("\n") ?? "";
    return codeBlock;
  },
};

export default Highlight;
